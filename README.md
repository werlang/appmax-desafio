# Appmax Desafio - Sistema Centralizador de Notifica√ß√µes

[![Node.js Version](https://img.shields.io/badge/node.js-24.x-green.svg)](https://nodejs.org/)
[![Docker](https://img.shields.io/badge/docker-ready-blue.svg)](https://www.docker.com/)
[![Tests](https://img.shields.io/badge/tests-215/215_passing-brightgreen.svg)](#testing)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

Um sistema robusto para centralizar todos os disparos de notifica√ß√µes (email, SMS, Telegram) com sistema de filas, tentativas autom√°ticas.

## üìã Sobre o Desafio

Este projeto foi desenvolvido como resposta ao desafio de construir um sistema que:

- ‚úÖ **Centraliza disparos de notifica√ß√µes** (email, SMS, Telegram)
- ‚úÖ **Consome disparos de um sistema de filas** com processamento ass√≠ncrono
- ‚úÖ **Sistema de tentativas configur√°vel** em caso de indisponibilidade dos servi√ßos
- ‚úÖ **Envios fake** para desenvolvimento e testes
- ‚úÖ **Cobertura completa de testes** (215/215 testes passando)
- ‚úÖ **Suporte completo a ES Modules** com mocking avan√ßado
- ‚úÖ **Rate limiting** e controle de retry configur√°vel

## üèóÔ∏è Arquitetura

### Componentes Principais

```
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ app.js              # Servidor Express principal com middleware CORS
‚îÇ   ‚îú‚îÄ‚îÄ controller.js       # Controladores de servi√ßos registrados dinamicamente
‚îÇ   ‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ queue.js        # Sistema de filas personalizado com UUID e callbacks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service-router.js # Roteador de servi√ßos com retry configur√°vel
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email.js        # Servi√ßo de email (Nodemailer + Ethereal para dev)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sms.js          # Servi√ßo de SMS (SMS.to API com encoding correto)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ telegram.js     # Servi√ßo Telegram (Bot API com rate limiting)
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/          # Suite completa de testes (215 testes)
‚îÇ       ‚îú‚îÄ‚îÄ setup.js        # Configura√ß√£o global de mocks
‚îÇ       ‚îú‚îÄ‚îÄ *.test.js       # Testes unit√°rios e integra√ß√£o
‚îÇ       ‚îî‚îÄ‚îÄ coverage/       # Relat√≥rios de cobertura
```

### Fluxo de Funcionamento

1. **Recep√ß√£o**: API REST recebe requisi√ß√µes de notifica√ß√£o
2. **Registro Din√¢mico**: Servi√ßos s√£o registrados via ServiceRouter
3. **Enfileiramento**: Mensagens s√£o adicionadas √† fila com UUID √∫nico  
4. **Processamento Sequencial**: Queue processa itens um por vez
5. **Retry Logic Configur√°vel**: Falhas s√£o repetidas at√© MAX_RETRIES (padr√£o: 5)
6. **Logging Inteligente**: Fake em desenvolvimento, real em produ√ß√£o
7. **Estado Persistente**: Redis para armazenamento de estado dos servi√ßos

## üöÄ Quick Start

### Pr√©-requisitos

- Node.js 24.x ou superior
- Docker e Docker Compose
- Git

### Instala√ß√£o com Docker

1. **Clone o reposit√≥rio**
```bash
git clone <repository-url>
cd appmax-desafio
```

2. **Configure vari√°veis de ambiente**
```bash
cp .env.example .env
# Edite o arquivo .env com suas credenciais
```

3. **Execute com Docker Compose**
```bash
docker-compose up -d
```

O sistema estar√° dispon√≠vel em `http://localhost:3000`

### Instala√ß√£o Manual

1. **Clone e instale depend√™ncias**
```bash
git clone <repository-url>
cd appmax-desafio/api
npm install
```

2. **Configure vari√°veis de ambiente**
```bash
cp ../.env.example ../.env
# Edite o arquivo .env
```

3. **Execute o servidor**
```bash
# Desenvolvimento (com nodemon)
npm run development

# Produ√ß√£o
npm run production
```

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente

```env
NODE_ENV=development                    # development | production | test
EMAIL_USER=your_email@example.com      # Email para SMTP (Gmail recomendado)
EMAIL_PASS=your_email_password          # Senha de app do email
TELEGRAM_BOT_TOKEN=your_telegram_token  # Token do bot Telegram (@BotFather)
SMS_API_KEY=your_sms_api_key           # Chave da API SMS.to
MAX_RETRIES=5                          # M√°ximo de tentativas (padr√£o: 5)
```

### Modo de Desenvolvimento

Em desenvolvimento (`NODE_ENV=development`):
- **Emails**: Usar contas de teste do Ethereal (geradas automaticamente)
- **SMS e Telegram**: Simulados com logs detalhados
- **Preview URLs**: Geradas para emails de teste
- **Mock Services**: Todos os servi√ßos externos s√£o simulados

### Modo de Teste

Em teste (`NODE_ENV=test`):
- **Todos os servi√ßos**: Completamente simulados
- **ES Modules Mocking**: `jest.unstable_mockModule` para mocking avan√ßado
- **Cobertura Completa**: 215 testes cobrindo todos os componentes
- **Isolation**: Cada teste √© isolado com mocks resetados

### Modo de Produ√ß√£o

Em produ√ß√£o (`NODE_ENV=production`):
- **Emails**: SMTP real configurado (Gmail/SendGrid/etc)
- **SMS**: API SMS.to com chave v√°lida
- **Telegram**: Bot real com token v√°lido
- **Retry Logic**: Configur√°vel via MAX_RETRIES

## üì° API Endpoints

### Health Check

```http
GET /ready
```

**Resposta:**
```json
{
  "message": "I am ready!"
}
```

### Envio de Email

```http
POST /email
Content-Type: application/json

{
  "to": "user@example.com",
  "subject": "Assunto do email",
  "message": "Conte√∫do da mensagem"
}
```

**Resposta:**
```json
{
  "status": "in queue",
  "position": 1,
  "id": "uuid-da-mensagem"
}
```

### Envio de SMS

```http
POST /sms
Content-Type: application/json

{
  "to": "+5511999999999",
  "message": "Sua mensagem SMS",
  "senderId": "SMSto"
}
### Consultando Status de Servi√ßo

```http
GET /service/:id
```

**Resposta (em processamento):**
```json
{
  "data": {...},
  "completed": false,
  "position": 2,
  "timestamp": 1694812800000
}
```

**Resposta (conclu√≠do):**
```json
{
  "data": {...},
  "completed": true,
  "timestamp": 1694812800000
}
```

**Resposta (n√£o encontrado):**
```json
{
  "error": "Service not found",
  "message": "Service not found."
}
```

## üß™ Testing

### Executando Testes

```bash
# Executar todos os testes
docker compose exec api npm test

# Executar testes espec√≠ficos
docker compose exec api npm test -- __tests__/email-service.test.js

# Executar com cobertura
docker compose exec api npm test -- --coverage

# Executar testes em watch mode
docker compose exec api npm test -- --watch
```

### Suite de Testes

**Estat√≠sticas de Testes:**
- ‚úÖ **215 testes passando** (100% success rate)
- ‚úÖ **7 suites de teste** completas
- ‚úÖ **Cobertura completa** de todos os componentes
- ‚úÖ **ES Modules Mocking** com `jest.unstable_mockModule`

**Testes por Componente:**
- **Controller Tests** (31 testes): Registro e execu√ß√£o de servi√ßos
- **EmailService Tests** (29 testes): SMTP, Ethereal, configura√ß√µes
- **Queue Tests** (26 testes): Processamento, callbacks, concorr√™ncia
- **ServiceRouter Tests** (28 testes): Retry logic, Redis, erros
- **SMSService Tests** (26 testes): API integration, encoding, timeouts
- **TelegramService Tests** (32 testes): Bot API, rate limiting, formatting
- **App Integration Tests** (42 testes): Express app, endpoints, CORS

### Configura√ß√£o de Testes

**Jest Configuration (`jest.config.js`):**
```javascript
export default {
  testEnvironment: 'node',
  transform: {},
  setupFilesAfterEnv: ['<rootDir>/__tests__/setup.js'],
  testMatch: ['**/__tests__/**/*.test.js'],
  collectCoverageFrom: [
    '**/*.js',
    '!**/node_modules/**',
    '!**/__tests__/**',
    '!**/coverage/**',
    '!jest.config.js'
  ],
  coverageDirectory: '__tests__/coverage',
  verbose: true
};
```

**Mock Setup (`__tests__/setup.js`):**
- Global mocks para `fetch`, `console.log`
- Redis mock para ServiceRouter
- Nodemailer mock para EmailService
- Environment variable management

## üîß Funcionalidades T√©cnicas

### Sistema de Filas Avan√ßado

- **Processamento Sequencial**: Uma mensagem por vez para evitar sobrecarga
- **IDs √önicos**: Cada item da fila recebe um UUID v4
- **Posicionamento**: Consulta da posi√ß√£o na fila em tempo real
- **Callbacks de Progresso**: Notifica√ß√µes ass√≠ncronas de mudan√ßas de estado
- **Tratamento de Erros**: Continuidade mesmo com falhas individuais
- **Concorr√™ncia Segura**: Thread-safe para m√∫ltiplas opera√ß√µes simult√¢neas

### Sistema de Retry Configur√°vel

- **MAX_RETRIES**: Configur√°vel via environment variable (padr√£o: 5)
- **Delay Incremental**: 1 segundo entre cada tentativa
- **Logging Detalhado**: Falhas s√£o logadas com stack trace completo
- **Recupera√ß√£o Autom√°tica**: Sistema continua processando ap√≥s falhas
- **Preven√ß√£o de Loop Infinito**: Limite r√≠gido de tentativas evita travamentos

### Servi√ßos de Notifica√ß√£o

#### Email Service (Nodemailer)
- **Provider SMTP**: Gmail, SendGrid, ou qualquer provedor SMTP
- **Desenvolvimento**: Ethereal.email para testes (auto-gerado)
- **Preview URLs**: Links para visualizar emails em desenvolvimento
- **Configura√ß√£o Flex√≠vel**: Host, porta, autentica√ß√£o customiz√°veis
- **Error Handling**: Timeouts, falhas de conex√£o, credenciais inv√°lidas
- **Content Types**: HTML e texto plano suportados

#### SMS Service (SMS.to API)
- **API Integration**: RESTful com `application/x-www-form-urlencoded`
- **N√∫meros Internacionais**: Suporte completo a formatos globais
- **Callback URLs**: Webhooks opcionais para status de entrega
- **Sender ID**: Configur√°vel por mensagem
- **URL Encoding**: Correto para caracteres especiais e emojis
- **Rate Limiting**: Respeita limites da API SMS.to

#### Telegram Service (Bot API)
- **Bot Token**: Obtido via @BotFather
- **Chat IDs**: Suporte a usu√°rios, grupos e canais
- **Formatting**: Texto plano e Markdown
- **URL Construction**: Query parameters com encoding correto
- **Error Handling**: Rate limiting, bot bloqueado, chat inexistente
- **Message Limits**: Respeita limite de 4096 caracteres

### Redis Integration

- **Service State**: Armazenamento persistente do estado dos servi√ßos
- **Queue Position**: Tracking de posi√ß√£o em tempo real
- **Completion Status**: Marca√ß√£o de servi√ßos conclu√≠dos
- **Connection Handling**: Graceful degradation em caso de falha do Redis

## üîç Logs e Monitoramento

### Logs de Desenvolvimento
```bash
# Visualizar logs em tempo real
docker-compose logs -f api
```

### Estrutura de Logs
- **Email enviado**: Preview URL e Message ID
- **SMS enviado**: Status da API e detalhes
- **Telegram enviado**: Resposta da API
- **Erros**: Stack trace completo
- **Queue**: Processamento de filas

## üß™ Testando o Sistema

### Teste Completo da API

1. **Health Check**
```bash
curl http://localhost:3000/ready
```

2. **Testando Email**
```bash
curl -X POST http://localhost:3000/email \
  -H "Content-Type: application/json" \
  -d '{
    "to": "test@example.com",
    "subject": "Teste Sistema",
    "message": "Este √© um teste do sistema de notifica√ß√µes"
  }'
```

3. **Testando SMS**
```bash
curl -X POST http://localhost:3000/sms \
  -H "Content-Type: application/json" \
  -d '{
    "to": "+5511999999999",
    "message": "Teste SMS do sistema",
    "senderId": "AppMax"
  }'
```

4. **Testando Telegram**
```bash
curl -X POST http://localhost:3000/telegram \
  -H "Content-Type: application/json" \
  -d '{
    "chatId": "123456789",
    "message": "üöÄ Teste Telegram do sistema"
  }'
```

5. **Consultando Status**
```bash
# Use o ID retornado na resposta anterior
curl http://localhost:3000/service/[UUID_DO_SERVICO]
```

### Testando com Postman

Uma cole√ß√£o do Postman est√° dispon√≠vel em:
```
appmax.postman_collection.json
```

**Importando no Postman:**
1. Abra o Postman
2. File > Import
3. Selecione o arquivo da cole√ß√£o
4. Configure as vari√°veis de ambiente se necess√°rio

### Testando Cen√°rios Espec√≠ficos

**Teste de Retry (simulando falha):**
```bash
# Configure MAX_RETRIES=2 no .env e pare o servi√ßo temporariamente
curl -X POST http://localhost:3000/email \
  -H "Content-Type: application/json" \
  -d '{"to": "test@fail.com", "subject": "Teste Retry"}'
```

**Teste de Concurrent Requests:**
```bash
# Execute m√∫ltiplas requisi√ß√µes simult√¢neas
for i in {1..5}; do
  curl -X POST http://localhost:3000/email \
    -H "Content-Type: application/json" \
    -d "{\"to\": \"test$i@example.com\", \"subject\": \"Teste $i\"}" &
done
wait
```

**Teste de Rate Limiting:**
```bash
# Teste com muitas requisi√ß√µes seguidas
seq 1 10 | xargs -n1 -P10 -I{} curl -X POST http://localhost:3000/telegram \
  -H "Content-Type: application/json" \
  -d '{"chatId": "123456789", "message": "Teste Rate Limit {}"}'
```

## üì¶ Estrutura do Projeto

```
appmax-desafio/
‚îú‚îÄ‚îÄ .env                     # Configura√ß√£o de ambiente (criado a partir do .example)
‚îú‚îÄ‚îÄ .env.example            # Exemplo de configura√ß√£o
‚îú‚îÄ‚îÄ .gitignore             # Arquivos ignorados pelo Git
‚îú‚îÄ‚îÄ compose.yaml           # Configura√ß√£o Docker Compose com Redis
‚îú‚îÄ‚îÄ README.md              # Este arquivo (documenta√ß√£o completa)
‚îú‚îÄ‚îÄ postman/               # Cole√ß√£o do Postman para testes
‚îÇ   ‚îî‚îÄ‚îÄ Appmax-Notifications.postman_collection.json
‚îî‚îÄ‚îÄ api/                   # C√≥digo da aplica√ß√£o Node.js
    ‚îú‚îÄ‚îÄ app.js            # Servidor Express principal (CORS, middleware, rotas)
    ‚îú‚îÄ‚îÄ controller.js     # Controladores com registro din√¢mico de servi√ßos
    ‚îú‚îÄ‚îÄ Dockerfile        # Imagem Docker multi-stage
    ‚îú‚îÄ‚îÄ package.json      # Depend√™ncias e scripts (ES modules)
    ‚îú‚îÄ‚îÄ jest.config.js    # Configura√ß√£o Jest para ES modules
    ‚îú‚îÄ‚îÄ helpers/          # Utilit√°rios do sistema
    ‚îÇ   ‚îú‚îÄ‚îÄ queue.js      # Sistema de filas com UUID e callbacks
    ‚îÇ   ‚îî‚îÄ‚îÄ service-router.js # Roteamento com retry configur√°vel
    ‚îú‚îÄ‚îÄ services/         # Servi√ßos de notifica√ß√£o
    ‚îÇ   ‚îú‚îÄ‚îÄ email.js      # Nodemailer + Ethereal para desenvolvimento
    ‚îÇ   ‚îú‚îÄ‚îÄ sms.js        # SMS.to API com encoding correto
    ‚îÇ   ‚îî‚îÄ‚îÄ telegram.js   # Telegram Bot API com rate limiting
    ‚îî‚îÄ‚îÄ __tests__/        # Suite completa de testes (215 testes)
        ‚îú‚îÄ‚îÄ setup.js      # Configura√ß√£o global de mocks
        ‚îú‚îÄ‚îÄ app.test.js           # Testes de integra√ß√£o Express (42 testes)
        ‚îú‚îÄ‚îÄ controller.test.js    # Testes do controller (31 testes)
        ‚îú‚îÄ‚îÄ email-service.test.js # Testes do EmailService (29 testes)
        ‚îú‚îÄ‚îÄ queue.test.js         # Testes do Queue (26 testes)
        ‚îú‚îÄ‚îÄ service-router.test.js # Testes do ServiceRouter (28 testes)
        ‚îú‚îÄ‚îÄ sms-service.test.js   # Testes do SMSService (26 testes)
        ‚îú‚îÄ‚îÄ telegram-service.test.js # Testes do TelegramService (32 testes)
        ‚îî‚îÄ‚îÄ coverage/            # Relat√≥rios de cobertura gerados pelo Jest
```

## üõ†Ô∏è Tecnologias Utilizadas

### Runtime e Framework
- **Node.js 24**: Runtime JavaScript com ES Modules
- **Express 5**: Framework web com middleware moderno
- **ES Modules**: Import/export nativo (n√£o CommonJS)

### Comunica√ß√£o e APIs
- **Nodemailer 7**: Envio de emails com suporte SMTP
- **SMS.to API**: Servi√ßo de SMS internacional
- **Telegram Bot API**: Messaging via bots
- **CORS**: Cross-Origin Resource Sharing configurado

### Banco de Dados e Cache
- **Redis (IORedis 5)**: Cache e persist√™ncia de estado
- **In-Memory Queue**: Sistema de filas personalizado

### Desenvolvimento e Testes
- **Jest 29**: Framework de testes com ES modules
- **Supertest 7**: Testes de integra√ß√£o HTTP
- **Nodemon 3**: Auto-reload em desenvolvimento
- **Docker Compose**: Orquestra√ß√£o de containers

### Qualidade e Monitoramento
- **UUID**: Identificadores √∫nicos para tracking
- **Environment Variables**: Configura√ß√£o flex√≠vel
- **Structured Logging**: Logs organizados por n√≠vel
- **Error Handling**: Tratamento robusto de erros

2. **Environment Setup**
```bash
cp .env.example .env
# Configure suas credenciais de desenvolvimento
```

3. **Install Dependencies**
```bash
cd api
npm install
```

4. **Run Tests**
```bash
# Certifique-se que todos os 215 testes passam
npm test
```

5. **Start Development Server**
```bash
npm run development
```

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo [LICENSE](LICENSE) para detalhes.

---

*Desenvolvido como parte do desafio t√©cnico Appmax - Sistema Centralizador de Notifica√ß√µes*